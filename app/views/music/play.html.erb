<div class="container mx-auto px-4 py-8">
  <div class="max-w-2xl mx-auto">
    <div class="bg-white shadow rounded-lg p-6">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold text-gray-900">瞑想音楽再生</h1>
        <%= link_to "← 音楽ライブラリに戻る", music_path,
            class: "text-blue-500 hover:text-blue-700" %>
      </div>

      <div class="mb-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-2">再生中の音楽</h2>
        <p class="text-gray-600"><%= @file_name %></p>
      </div>

      <div class="mb-6 flex flex-col items-center justify-center">
        <div style="display: flex; justify-content: center; align-items: center; width: 100%;">
          <audio id="audio-player" controls style="width:40%; height:60px; transform: scale(1.25);">
            <source src="<%= music_stream_path(@file_id) %>" type="audio/mpeg">
            お使いのブラウザは音声再生をサポートしていません。
          </audio>
        </div>
      </div>

      <div class="border-t pt-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">瞑想記録</h3>
        
        <%= form_with model: @meditation_record, local: true, id: "meditation-form", data: { turbo: false } do |form| %>
          <div class="mb-4">
            <%= form.label :duration, "瞑想時間（分）", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= form.number_field :duration, id: "meditation-duration", 
                class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",
                min: 1, max: 480 %>
          </div>

          <div class="mb-4">
            <%= form.label :notes, "メモ", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= form.text_area :notes, rows: 3,
                class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",
                placeholder: "瞑想の感想や気づきを記録してください..." %>
          </div>

          <div class="flex space-x-4">
            <%= form.submit "記録を保存", 
                class: "bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" %>
          </div>
        <% end %>
        <div class="mt-6 flex justify-center">
          <%= link_to "記録を見る", meditation_records_path, class: "bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded" %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('turbo:load', function() {
  const audio = document.getElementById('audio-player');
  const meditationDuration = document.getElementById('meditation-duration');

  // 再生バーの再生時間を瞑想時間欄に自動反映
  audio.addEventListener('timeupdate', function() {
    // 再生位置（秒）を分単位で切り上げ
    const minutes = Math.ceil(audio.currentTime / 60);
    meditationDuration.value = minutes;
  });
});
</script> 